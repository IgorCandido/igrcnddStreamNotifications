
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-styles/color.html">
<link rel="import" href="../paper-styles/default-theme.html">
<link rel="import" href="../paper-ripple/paper-ripple.html">
<link rel="import" href="../paper-behaviors/paper-checked-element-behavior.html">
<link rel="import" href="../nodecg-replicant/nodecg-replicant-targeting.html">

<!--
`nodecg-toggle` is a custom implementation of [`paper-toggle-button`](https://elements.polymer-project.org/elements/paper-toggle-button)
that binds its value to a NodeCG Replicant.

It has all the same properties and methods as `paper-toggle-button`, but adds two more: `replicantName` and `replicantBundle`.

    <nodecg-toggle replicant-name="myReplicant">Label</nodecg-toggle>

`replicantBundle` is optional and defaults to the value of the current bundle.
-->

<dom-module id="nodecg-toggle">
    <template strip-whitespace>

        <style>
            :host {
                display: inline-block;
            }

            :host([disabled]) {
                pointer-events: none;
            }

            :host(:focus) {
                outline:none;
            }

            .toggle-bar {
                position: absolute;
                height: 100%;
                width: 100%;
                border-radius: 8px;
                pointer-events: none;
                opacity: 0.4;
                transition: background-color linear .08s;
                background-color: var(--paper-toggle-button-unchecked-bar-color, #000000);
            @apply(--paper-toggle-button-unchecked-bar);
            }

            .toggle-button {
                position: absolute;
                top: -3px;
                height: 20px;
                width: 20px;
                border-radius: 50%;
                box-shadow: 0 1px 5px 0 rgba(0, 0, 0, 0.6);
                transition: -webkit-transform linear .08s, background-color linear .08s;
                transition: transform linear .08s, background-color linear .08s;
                will-change: transform;
                background-color: var(--paper-toggle-button-unchecked-button-color, --paper-grey-50);
            @apply(--paper-toggle-button-unchecked-button);
            }

            .toggle-button.dragging {
                -webkit-transition: none;
                transition: none;
            }

            :host([checked]:not([disabled])) .toggle-bar {
                opacity: 0.5;
                background-color: var(--paper-toggle-button-checked-bar-color, --default-primary-color);
            @apply(--paper-toggle-button-checked-bar);
            }

            :host([disabled]) .toggle-bar {
                background-color: #000;
                opacity: 0.12;
            }

            :host([checked]) .toggle-button {
                -webkit-transform: translate(16px, 0);
                transform: translate(16px, 0);
            }

            :host([checked]:not([disabled])) .toggle-button {
                background-color: var(--paper-toggle-button-checked-button-color, --default-primary-color);
            @apply(--paper-toggle-button-checked-button);
            }

            :host([disabled]) .toggle-button {
                background-color: #bdbdbd;
                opacity: 1;
            }

            .toggle-ink {
                position: absolute;
                top: -14px;
                left: -14px;
                width: 48px;
                height: 48px;
                opacity: 0.5;
                pointer-events: none;
                color: var(--paper-toggle-button-unchecked-ink-color, --primary-text-color);
            }

            :host([checked]) .toggle-ink {
                color: var(--paper-toggle-button-checked-ink-color, --default-primary-color);
            }

            .toggle-container {
                display: inline-block;
                position: relative;
                width: 36px;
                height: 14px;
            }

            .toggle-label {
                position: relative;
                top: -2px;
                display: inline-block;
                vertical-align: middle;
                margin-left: 10px;
                white-space: normal;
                pointer-events: none;
                color: var(--paper-toggle-button-label-color, --primary-text-color);
            }
        </style>

        <div class="toggle-container">
            <div id="toggleBar" class="toggle-bar"></div>
            <div id="toggleButton" class="toggle-button"></div>
        </div>

        <div class="toggle-label"><content></content></div>

    </template>

    <script>
        Polymer({
            is: 'nodecg-toggle',

            behaviors: [
                Polymer.PaperCheckedElementBehavior,
                Polymer.NodeCGReplicantTargetingBehavior
            ],

            hostAttributes: {
                role: 'button',
                'aria-pressed': 'false',
                tabindex: 0
            },

            properties: {
                /**
                 * Fired when the checked state changes due to user interaction.
                 *
                 * @event change
                 */
                /**
                 * Fired when the checked state changes.
                 *
                 * @event iron-change
                 */
            },

            listeners: {
                track: '_ontrack',
                'iron-change': '_onIronChange'
            },

            _ontrack: function(event) {
                var track = event.detail;
                if (track.state === 'start') {
                    this._trackStart(track);
                } else if (track.state === 'track') {
                    this._trackMove(track);
                } else if (track.state === 'end') {
                    this._trackEnd(track);
                }
            },

            _trackStart: function(track) {
                this._width = this.$.toggleBar.offsetWidth / 2;
                /*
                 * keep an track-only check state to keep the dragging behavior smooth
                 * while toggling activations
                 */
                this._trackChecked = this.checked;
                this.$.toggleButton.classList.add('dragging');
            },

            _trackMove: function(track) {
                var dx = track.dx;
                this._x = Math.min(this._width,
                    Math.max(0, this._trackChecked ? this._width + dx : dx));
                this.translate3d(this._x + 'px', 0, 0, this.$.toggleButton);
                this._userActivate(this._x > (this._width / 2));
            },

            _trackEnd: function(track) {
                this.$.toggleButton.classList.remove('dragging');
                this.transform('', this.$.toggleButton);
            },

            // customize the element's ripple
            _createRipple: function() {
                this._rippleContainer = this.$.toggleButton;
                var ripple = Polymer.PaperRippleBehavior._createRipple();
                ripple.id = 'ink';
                ripple.setAttribute('recenters', '');
                ripple.classList.add('circle', 'toggle-ink');
                return ripple;
            },

            _onIronChange: function(e) {
                if (typeof this.replicant !== 'object') return;
                this.replicant.value = e.target.checked;
            },

            _replicantChanged: function(newVal) {
                this.checked = !!newVal;
            }

        });
    </script>
</dom-module>
